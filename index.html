<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Pokémon TCG - São Paulo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pkmn-blue': '#1c3b69',
                        'pkmn-red': '#e63946',
                        'pkmn-bg': '#e8f0f8',
                        'pkmn-header-bg': '#d6e2ef',
                        'pkmn-light-blue': '#a8dadc',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #aaa;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Simple transition for table rows */
        .table-row-hover:hover {
            background-color: #f0f0f0;
        }
        /* Styles for sort indicators */
        .sort-indicator::after {
            content: '';
            display: inline-block;
            margin-left: 0.5rem;
            opacity: 0.5;
            font-size: 0.65em;
            vertical-align: middle;
        }
        th[data-sort-direction="asc"] .sort-indicator::after {
            content: '▲';
            opacity: 1;
            color: #e63946;
        }
        th[data-sort-direction="desc"] .sort-indicator::after {
            content: '▼';
            opacity: 1;
            color: #e63946;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e63946;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .poke-btn {
            transition: transform 0.2s;
        }
        .poke-btn:active {
            transform: scale(1.2) rotate(20deg);
        }
    </style>
</head>
<body class="bg-pkmn-bg text-gray-800 pb-20">

    <div class="container mx-auto p-2 sm:p-4 md:p-8">
        <header class="text-center mb-6 p-3 sm:p-6 bg-pkmn-header-bg rounded-xl border-b-4 border-pkmn-light-blue">
            <h1 class="text-2xl sm:text-4xl md:text-5xl font-black text-pkmn-blue uppercase tracking-widest">TOWN MAP</h1>
            <p class="text-xs sm:text-md text-gray-600 mt-1 sm:mt-3 tracking-wider">Torneios de Pokémon TCG em São Paulo</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-3 sm:p-6 relative">
            <!-- API Status Section -->
            <div id="api-status-section" class="mb-6 p-4 border-l-4 border-pkmn-blue bg-blue-50 rounded-r-lg flex items-center justify-between">
                <div class="flex items-center">
                    <div id="loading-spinner" class="loader"></div>
                    <div>
                        <p id="status-message" class="font-bold text-pkmn-blue">Conectando à PokéData API...</p>
                        <p id="status-subtext" class="text-xs text-gray-500">Buscando eventos recentes.</p>
                    </div>
                </div>
                <button id="retry-button" class="hidden px-4 py-2 bg-pkmn-red text-white text-sm font-bold rounded hover:bg-red-700 transition">
                    Tentar Novamente
                </button>
            </div>

            <!-- Filter and Search Controls -->
            <div class="mb-4 flex flex-col sm:flex-row gap-2 items-center">
                <div class="w-full flex-grow">
                    <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Pesquisar</label>
                    <input type="text" id="search-input" placeholder="Buscar por nome, cidade, loja..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition">
                </div>
                <div class="w-full sm:w-auto mt-auto">
                    <button id="saved-filter-btn" class="w-full sm:w-auto h-[42px] mt-6 sm:mt-0 px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 hover:bg-gray-50 hover:text-pkmn-red hover:border-pkmn-red transition flex items-center justify-center space-x-2 font-medium group">
                         <!-- Pokéball Icon for Filter Button -->
                        <svg id="saved-filter-icon" class="w-5 h-5 group-hover:text-pkmn-red transition-colors" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                             <circle cx="12" cy="12" r="9" />
                             <path d="M3 12h18" />
                             <circle cx="12" cy="12" r="3" class="fill-white" />
                        </svg>
                        <span id="saved-filter-text">Ver Salvos</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
                <div>
                    <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Tipo</label>
                    <select id="type-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todos os Tipos</option>
                    </select>
                </div>
                <!-- Custom Multi-select Dropdown for Cities -->
                <div class="relative" id="city-filter-wrapper">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Cidade</label>
                    <button id="city-filter-btn" type="button" class="w-full text-left px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition flex justify-between items-center text-sm h-[42px]">
                        <span id="city-filter-label" class="truncate block w-full pr-2">Todas as Cidades</span>
                        <svg class="w-4 h-4 ml-1 flex-shrink-0 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <!-- Dropdown Content -->
                    <div id="city-dropdown" class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                        <div class="p-2 border-b bg-gray-50 sticky top-0 z-10">
                            <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-gray-100">
                                <input type="checkbox" id="city-all" value="all" checked class="rounded text-pkmn-red focus:ring-pkmn-red h-4 w-4 border-gray-300">
                                <span class="text-sm font-semibold text-pkmn-blue">Todas as Cidades</span>
                            </label>
                        </div>
                        <div id="city-list" class="p-2 space-y-1">
                            <!-- Checkboxes will be injected here -->
                        </div>
                    </div>
                </div>
                <div>
                    <label for="month-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Mês</label>
                    <select id="month-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todos os Meses</option>
                    </select>
                </div>
            </div>

            <!-- Events Table -->
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-pkmn-header-bg">
                        <tr>
                            <th scope="col" class="px-2 py-3 w-10 text-center">
                                <span class="sr-only">Favorito</span>
                            </th>
                            <th scope="col" class="hidden sm:table-cell px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="name">Evento<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="type">Tipo<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="when">Data<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="shop">Loja<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="city">Cidade<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="events-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
                 <div id="no-results" class="text-center py-8 text-gray-500 hidden">
                    <p>Nenhum evento encontrado.</p>
                </div>
            </div>
        </main>

        <!-- Details Modal/Panel -->
        <div id="details-panel" class="fixed inset-y-0 right-0 w-full sm:w-2/3 md:w-1/2 lg:w-1/3 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto border-l-4 border-pkmn-blue">
             <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="details-name" class="text-xl font-bold text-pkmn-blue">Detalhes do Evento</h2>
                    <button id="close-details" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="details-content" class="space-y-4 text-sm">
                    <!-- Details will be dynamically inserted here -->
                </div>
            </div>
        </div>
        <div id="details-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const API_URL = 'https://pokedata.ovh/events/api/_tcg/cups/challenges/pre/_country/BR'; 
            const STORAGE_KEY = 'pkmn_saved_events';

            // --- DOM Elements ---
            const tableBody = document.getElementById('events-table-body');
            const searchInput = document.getElementById('search-input');
            const typeFilter = document.getElementById('type-filter');
            // City filter elements
            const cityFilterWrapper = document.getElementById('city-filter-wrapper');
            const cityFilterBtn = document.getElementById('city-filter-btn');
            const cityFilterLabel = document.getElementById('city-filter-label');
            const cityDropdown = document.getElementById('city-dropdown');
            const cityListContainer = document.getElementById('city-list');
            const cityAllCheckbox = document.getElementById('city-all');
            
            const monthFilter = document.getElementById('month-filter');
            const savedFilterBtn = document.getElementById('saved-filter-btn');
            const savedFilterIcon = document.getElementById('saved-filter-icon');
            const savedFilterText = document.getElementById('saved-filter-text');

            const detailsPanel = document.getElementById('details-panel');
            const detailsOverlay = document.getElementById('details-overlay');
            const closeDetailsButton = document.getElementById('close-details');
            const detailsName = document.getElementById('details-name');
            const detailsContent = document.getElementById('details-content');
            const noResultsDiv = document.getElementById('no-results');
            
            // Status Elements
            const statusMessage = document.getElementById('status-message');
            const statusSubtext = document.getElementById('status-subtext');
            const loadingSpinner = document.getElementById('loading-spinner');
            const retryButton = document.getElementById('retry-button');
            const apiStatusSection = document.getElementById('api-status-section');

            let allEvents = [];
            let currentSort = { key: 'when', direction: 'asc' };
            
            // Saved Events Logic (LocalStorage)
            let savedEventIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));
            let showSavedOnly = false;

            // --- API Handling ---
            async function fetchEventsFromAPI() {
                setLoadingState(true);
                let data;
                
                try {
                    try {
                        console.log("Tentando conexão direta...");
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error('Erro na conexão direta');
                        data = await response.json();
                    } catch (directError) {
                        console.warn("Conexão direta falhou (provavelmente CORS), tentando proxy...", directError);
                        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(API_URL);
                        const proxyResponse = await fetch(proxyUrl);
                        if (!proxyResponse.ok) throw new Error('Erro na conexão via proxy');
                        data = await proxyResponse.json();
                    }
                    
                    let eventsArray = Array.isArray(data) ? data : (data.events || []);

                    if (!eventsArray || eventsArray.length === 0) {
                        throw new Error("A API retornou uma lista vazia de eventos no Brasil.");
                    }

                    // Add unique IDs to events for selection tracking
                    // Generating a pseudo-unique ID based on props to persist across sessions better than index
                    eventsArray = eventsArray.map((e, index) => {
                         // Fallback ID: name + date + shop + city (hash-like)
                         const rawId = `${e.name || ''}_${e.when || ''}_${e.shop || ''}`.replace(/\s/g, '').toLowerCase();
                         return { ...e, uniqueId: rawId };
                    });

                    // FILTRO ROBUSTO: Manter apenas eventos de São Paulo
                    allEvents = eventsArray.filter(event => {
                         if (!event) return false;
                         const state = (event.state || '').toString().trim().toUpperCase();
                         const city = (event.city || '').toString().trim().toUpperCase();
                         const removeAccents = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                         const cleanState = removeAccents(state);
                         const cleanCity = removeAccents(city);

                         return cleanState === 'SP' || 
                                cleanState.includes('SAO PAULO') || 
                                cleanCity.includes('SAO PAULO');
                    });

                    setLoadingState(false, true);
                    
                    if (allEvents.length === 0) {
                        console.warn("Eventos carregados do Brasil, mas nenhum correspondeu ao filtro 'São Paulo'.");
                        noResultsDiv.classList.remove('hidden');
                        noResultsDiv.querySelector('p').textContent = "Conectado à API, mas nenhum evento encontrado em São Paulo no momento.";
                    } else {
                        populateFilters(allEvents);
                        filterAndSortEvents();
                    }

                } catch (error) {
                    console.error("Falha crítica ao buscar API:", error);
                    setLoadingState(false, false, error.message);
                }
            }

            function setLoadingState(isLoading, isSuccess = false, errorMessage = '') {
                if (isLoading) {
                    loadingSpinner.style.display = 'inline-block';
                    retryButton.classList.add('hidden');
                    statusMessage.textContent = "Conectando à PokéData API...";
                    statusMessage.className = "font-bold text-pkmn-blue";
                    statusSubtext.textContent = "Buscando eventos recentes (Tentando conexão direta e proxy)...";
                    apiStatusSection.className = "mb-6 p-4 border-l-4 border-pkmn-blue bg-blue-50 rounded-r-lg flex items-center justify-between";
                } else if (isSuccess) {
                    loadingSpinner.style.display = 'none';
                    statusMessage.textContent = "Dados Atualizados!";
                    statusMessage.className = "font-bold text-green-700";
                    statusSubtext.textContent = `Carregados ${allEvents.length} eventos em São Paulo.`;
                    apiStatusSection.className = "mb-6 p-4 border-l-4 border-green-500 bg-green-50 rounded-r-lg flex items-center justify-between";
                    setTimeout(() => {
                        apiStatusSection.classList.add('hidden');
                    }, 5000);
                } else {
                    loadingSpinner.style.display = 'none';
                    retryButton.classList.remove('hidden');
                    statusMessage.textContent = "Erro ao carregar dados";
                    statusMessage.className = "font-bold text-red-700";
                    statusSubtext.textContent = `Não foi possível carregar os dados. Detalhe: ${errorMessage}`;
                    apiStatusSection.className = "mb-6 p-4 border-l-4 border-pkmn-red bg-red-50 rounded-r-lg flex items-center justify-between";
                }
            }

            // --- Saved Events Logic ---
            function toggleSaveEvent(id) {
                if (savedEventIds.has(id)) {
                    savedEventIds.delete(id);
                } else {
                    savedEventIds.add(id);
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify([...savedEventIds]));
                
                // If filtering by saved, refresh the whole list logic
                if (showSavedOnly) {
                    filterAndSortEvents();
                } else {
                    // Just re-render to update icons
                    filterAndSortEvents();
                }
            }

            function toggleSavedFilter() {
                showSavedOnly = !showSavedOnly;
                
                if (showSavedOnly) {
                    savedFilterBtn.classList.add('bg-pkmn-red', 'text-white', 'border-pkmn-red');
                    savedFilterBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                    savedFilterText.textContent = "Mostrando Salvos";
                } else {
                    savedFilterBtn.classList.remove('bg-pkmn-red', 'text-white', 'border-pkmn-red');
                    savedFilterBtn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                    savedFilterText.textContent = "Ver Salvos";
                }
                
                filterAndSortEvents();
            }

            // --- UI Rendering ---
            function renderTable(events) {
                tableBody.innerHTML = '';
                if (events.length === 0) {
                    noResultsDiv.classList.remove('hidden');
                    if (allEvents.length > 0) {
                        if (showSavedOnly) {
                            noResultsDiv.querySelector('p').textContent = "Você ainda não salvou nenhum evento.";
                        } else {
                            noResultsDiv.querySelector('p').textContent = "Nenhum resultado encontrado para os filtros aplicados.";
                        }
                    }
                } else {
                    noResultsDiv.classList.add('hidden');
                }
                
                events.forEach(event => {
                    const row = document.createElement('tr');
                    row.className = 'cursor-pointer table-row-hover transition-colors duration-200';
                    
                    const whenDate = new Date(event.when);
                    const formattedDate = !isNaN(whenDate) ? 
                        whenDate.toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            timeZone: 'America/Sao_Paulo'
                        }) : 'Data inválida';

                    let abbreviatedType = event.type || 'Evento';
                    let fullTypeName = event.type || 'Evento';
                    let typeClass = 'bg-gray-100 text-gray-800'; // Default

                    if (fullTypeName === 'League Challenge') {
                        abbreviatedType = 'Challenge';
                        typeClass = 'bg-blue-100 text-blue-800';
                    } else if (fullTypeName === 'League Cup') {
                        abbreviatedType = 'Cup';
                        typeClass = 'bg-red-100 text-red-800';
                    } else if (fullTypeName && fullTypeName.toLowerCase().includes('prerelease')) {
                        abbreviatedType = 'Pré Release';
                        fullTypeName = 'Pré Release'; // Manter consistência
                        typeClass = 'bg-green-100 text-green-800';
                    }

                    // Saved Logic - Pokéball Visuals
                    const isSaved = savedEventIds.has(event.uniqueId);
                    const pokeClass = isSaved ? 'text-gray-800' : 'text-gray-400 hover:text-gray-600';
                    
                    // Custom SVG for Half-Red Pokéball
                    // Outline is currentColor. Fill Top is red if saved.
                    const pokeSVG = `
                        <svg class="w-6 h-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                            <!-- Top Half Fill (Red if saved) -->
                            <path d="M21 12A9 9 0 0 0 3 12Z" class="${isSaved ? 'fill-pkmn-red stroke-none' : 'hidden'}" />
                            
                            <!-- Main Circle Outline -->
                            <circle cx="12" cy="12" r="9" />
                            
                            <!-- Middle Line -->
                            <path stroke-linecap="round" d="M3 12h18" />
                            
                            <!-- Center Button (White) -->
                            <circle cx="12" cy="12" r="3" class="fill-white" />
                            <circle cx="12" cy="12" r="1.5" class="fill-gray-800 stroke-none" />
                        </svg>
                    `;

                    row.innerHTML = `
                        <td class="px-2 py-3 w-10 text-center" onclick="event.stopPropagation()">
                             <button class="poke-btn focus:outline-none ${pokeClass}" data-id="${event.uniqueId}" title="${isSaved ? 'Remover dos salvos' : 'Salvar evento'}">
                                ${pokeSVG}
                             </button>
                        </td>
                        <td class="hidden sm:table-cell px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">
                            <div class="font-medium text-gray-900">${event.name || 'Sem Nome'}</div>
                        </td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">
                             <span class="sm:hidden px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                ${abbreviatedType}
                            </span>
                             <span class="hidden sm:inline-flex px-2 text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                ${fullTypeName}
                            </span>
                        </td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${formattedDate}</td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${event.shop || '-'}</td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${event.city || '-'}</td>
                    `;
                    
                    // Click on row opens details
                    row.addEventListener('click', (e) => {
                        showDetails(event)
                    });

                    // Poke Button Click
                    const pokeBtn = row.querySelector('.poke-btn');
                    pokeBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Stop row click
                        toggleSaveEvent(event.uniqueId);
                    });

                    tableBody.appendChild(row);
                });
            }

            function populateFilters(events) {
                const currentType = typeFilter.value;
                const currentMonth = monthFilter.value;

                // --- Type Filter ---
                typeFilter.innerHTML = '<option value="all">Todos os Tipos</option>';
                const types = [...new Set(events.map(e => e.type))];
                types.forEach(type => {
                    if(!type) return;
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type.toLowerCase().includes('prerelease') ? 'Pré Release' : type;
                    typeFilter.appendChild(option);
                });
                if ([...typeFilter.options].some(o => o.value === currentType)) typeFilter.value = currentType;

                // --- City Filter (Multi-select) ---
                cityListContainer.innerHTML = ''; 
                const cities = [...new Set(events.map(e => e.city))].sort((a, b) => (a || '').localeCompare(b || ''));

                cities.forEach(city => {
                    if (city) {
                        const div = document.createElement('div');
                        div.className = 'flex items-center space-x-2 p-1 rounded hover:bg-gray-50';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = city;
                        checkbox.className = 'city-checkbox rounded text-pkmn-red focus:ring-pkmn-red h-4 w-4 border-gray-300 cursor-pointer';
                        
                        const label = document.createElement('label');
                        label.textContent = city;
                        label.className = 'text-sm text-gray-700 cursor-pointer flex-grow';
                        
                        label.addEventListener('click', () => { checkbox.checked = !checkbox.checked; checkbox.dispatchEvent(new Event('change')); });
                        
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        cityListContainer.appendChild(div);

                        checkbox.addEventListener('change', () => {
                            if (checkbox.checked) {
                                cityAllCheckbox.checked = false; 
                            } else {
                                const anyChecked = document.querySelectorAll('.city-checkbox:checked').length > 0;
                                if (!anyChecked) cityAllCheckbox.checked = true;
                            }
                            updateCityButtonLabel();
                            filterAndSortEvents();
                        });
                    }
                });

                // --- Month Filter ---
                monthFilter.innerHTML = '<option value="all">Todos os Meses</option>';
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const months = [...new Set(events.map(e => {
                    const date = new Date(e.when);
                    return isNaN(date) ? null : date.getUTCMonth();
                }).filter(m => m !== null))].sort((a, b) => a - b);

                months.forEach(monthIndex => {
                    const option = document.createElement('option');
                    option.value = monthIndex;
                    option.textContent = monthNames[monthIndex];
                    monthFilter.appendChild(option);
                });
                if ([...monthFilter.options].some(o => o.value === currentMonth)) monthFilter.value = currentMonth;
                
                updateCityButtonLabel();
            }

            function updateCityButtonLabel() {
                if (cityAllCheckbox.checked) {
                    cityFilterLabel.textContent = "Todas as Cidades";
                    cityFilterLabel.className = "truncate block w-full pr-2 font-normal text-gray-700";
                    return;
                }

                const checkedBoxes = document.querySelectorAll('.city-checkbox:checked');
                const count = checkedBoxes.length;

                if (count === 0) {
                    cityAllCheckbox.checked = true; 
                    cityFilterLabel.textContent = "Todas as Cidades";
                    cityFilterLabel.className = "truncate block w-full pr-2 font-normal text-gray-700";
                } else if (count === 1) {
                    cityFilterLabel.textContent = checkedBoxes[0].value;
                    cityFilterLabel.className = "truncate block w-full pr-2 font-bold text-pkmn-blue";
                } else {
                    cityFilterLabel.textContent = `${count} Cidades Selecionadas`;
                    cityFilterLabel.className = "truncate block w-full pr-2 font-bold text-pkmn-blue";
                }
            }

            // --- Details Panel ---
            function showDetails(event) {
                detailsName.textContent = event.name || 'Detalhes do Evento';
                
                const whenDate = new Date(event.when);
                const formattedDate = !isNaN(whenDate) ? whenDate.toLocaleString('pt-br', { dateStyle: 'full', timeStyle: 'short', timeZone: 'America/Sao_Paulo' }) : 'Data inválida';
                const address = event.address || event.street_address || event.street_adress || 'Endereço não informado';

                let pokemonEventLinkHTML = '';
                if (event.pokemon_url && event.pokemon_url.trim() !== '') {
                    let officialEventUrl = event.pokemon_url;
                    if (!officialEventUrl.startsWith('http')) {
                        officialEventUrl = `https://www.pokemon.com/us/play-pokemon/pokemon-events/${event.pokemon_url}`;
                    }

                    pokemonEventLinkHTML = `
                        <a href="${officialEventUrl}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center inline-block bg-pkmn-blue text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 transition">
                           Página do Evento
                        </a>`;
                }

                // Google Calendar Link Logic (Single Event)
                const start = whenDate.toISOString().replace(/-|:|\.\d\d\d/g,""); // Format YYYYMMDDTHHmmSSZ (UTC)
                const end = new Date(whenDate.getTime() + (4*60*60*1000)).toISOString().replace(/-|:|\.\d\d\d/g,"");
                
                const gCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.name)}&dates=${start}/${end}&details=${encodeURIComponent("Tipo: " + event.type + "\nLoja: " + event.shop)}&location=${encodeURIComponent(event.shop + " - " + event.city)}`;

                // Save button logic for details panel
                const isSaved = savedEventIds.has(event.uniqueId);
                const saveBtnText = isSaved ? 'Remover dos Salvos' : 'Salvar Evento';
                
                // SVG for PokeBall
                const pokeSVG = `
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                        <path d="M21 12A9 9 0 0 0 3 12Z" class="${isSaved ? 'fill-pkmn-red stroke-none' : 'hidden'}" />
                        <circle cx="12" cy="12" r="9" />
                        <path stroke-linecap="round" d="M3 12h18" />
                        <circle cx="12" cy="12" r="3" class="fill-white" />
                        <circle cx="12" cy="12" r="1.5" class="fill-gray-800 stroke-none" />
                    </svg>
                `;

                const saveBtnClass = isSaved 
                    ? 'bg-gray-100 text-gray-800 border-2 border-pkmn-red' 
                    : 'bg-white text-gray-700 hover:bg-gray-50 border-2 border-gray-300 hover:border-pkmn-red';


                detailsContent.innerHTML = `
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Tipo:</strong> ${event.type || '-'}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Loja:</strong> ${event.shop || '-'}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Data:</strong> ${formattedDate}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Endereço:</strong> ${address}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Cidade:</strong> ${event.city || '-'}, ${event.state || ''}</p>
                    <div class="mt-6 space-y-2">
                         <button id="details-save-btn" class="w-full text-center inline-flex items-center justify-center font-bold py-2 px-4 rounded-lg transition ${saveBtnClass}">
                            ${pokeSVG} ${saveBtnText}
                        </button>

                        <a href="${gCalUrl}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center inline-block bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">
                           Adicionar ao Google Agenda
                        </a>

                        <a href="https://www.google.com/maps?q=${event.latitude},${event.longitude}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center inline-block bg-pkmn-red text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                           Ver no Google Maps
                        </a>
                        ${pokemonEventLinkHTML}
                    </div>
                `;

                // Add listener to new button
                document.getElementById('details-save-btn').addEventListener('click', () => {
                    toggleSaveEvent(event.uniqueId);
                    showDetails(event); // Re-render details to update button state
                });

                detailsPanel.classList.remove('translate-x-full');
                detailsOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            function hideDetails() {
                detailsPanel.classList.add('translate-x-full');
                detailsOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // --- Filtering and Sorting Logic ---
            function filterAndSortEvents() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedType = typeFilter.value;
                const selectedMonth = monthFilter.value;
                
                const isAllCities = cityAllCheckbox.checked;
                const selectedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);

                let filtered = allEvents.filter(event => {
                    // Check saved filter first
                    if (showSavedOnly && !savedEventIds.has(event.uniqueId)) {
                        return false;
                    }

                    const matchesSearch = searchTerm === '' || 
                        Object.values(event).some(val => 
                            String(val).toLowerCase().includes(searchTerm)
                        );
                    const matchesType = selectedType === 'all' || event.type === selectedType;
                    const matchesCity = isAllCities || selectedCities.includes(event.city);
                    const eventDate = new Date(event.when);
                    const matchesMonth = selectedMonth === 'all' || (isNaN(eventDate) ? false : eventDate.getUTCMonth() == selectedMonth);
                    
                    return matchesSearch && matchesType && matchesCity && matchesMonth;
                });
                
                filtered.sort((a, b) => {
                    let valA = a[currentSort.key];
                    let valB = b[currentSort.key];

                    if (currentSort.key === 'when') {
                        valA = new Date(valA).getTime();
                        valB = new Date(valB).getTime();
                    } else if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }

                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                renderTable(filtered);
            }
            
            function handleSort(e) {
                const th = e.target.closest('th[data-sort]');
                if (!th) return;
                
                const key = th.dataset.sort;

                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = key;
                    currentSort.direction = 'asc';
                }
                
                document.querySelectorAll('th[data-sort]').forEach(header => {
                    header.removeAttribute('data-sort-direction');
                });
                th.setAttribute('data-sort-direction', currentSort.direction);

                filterAndSortEvents();
            }
            
            // --- Initial Setup & Event Listeners ---
            searchInput.addEventListener('input', filterAndSortEvents);
            typeFilter.addEventListener('change', filterAndSortEvents);
            monthFilter.addEventListener('change', filterAndSortEvents);
            closeDetailsButton.addEventListener('click', hideDetails);
            detailsOverlay.addEventListener('click', hideDetails);
            document.querySelector('thead').addEventListener('click', handleSort);
            retryButton.addEventListener('click', fetchEventsFromAPI);
            savedFilterBtn.addEventListener('click', toggleSavedFilter);

            // --- Multi-select Dropdown Events ---
            cityFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                cityDropdown.classList.toggle('hidden');
            });

            cityAllCheckbox.addEventListener('change', () => {
                if (cityAllCheckbox.checked) {
                    document.querySelectorAll('.city-checkbox').forEach(cb => cb.checked = false);
                } else {
                    const anyChecked = document.querySelectorAll('.city-checkbox:checked').length > 0;
                    if (!anyChecked) cityAllCheckbox.checked = true;
                }
                updateCityButtonLabel();
                filterAndSortEvents();
            });

            document.addEventListener('click', (e) => {
                if (!cityFilterWrapper.contains(e.target)) {
                    cityDropdown.classList.add('hidden');
                }
            });
            
            // Start Load
            fetchEventsFromAPI();
        });
    </script>
</body>
</html>
