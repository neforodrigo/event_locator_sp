<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Pokémon TCG - São Paulo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pkmn-blue': '#1c3b69',
                        'pkmn-red': '#e63946',
                        'pkmn-bg': '#e8f0f8',
                        'pkmn-header-bg': '#d6e2ef',
                        'pkmn-light-blue': '#a8dadc',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #aaa;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Simple transition for table rows */
        .table-row-hover:hover {
            background-color: #f0f0f0;
        }
        /* Styles for sort indicators */
        .sort-indicator::after {
            content: '';
            display: inline-block;
            margin-left: 0.5rem;
            opacity: 0.5;
            font-size: 0.65em;
            vertical-align: middle;
        }
        th[data-sort-direction="asc"] .sort-indicator::after {
            content: '▲';
            opacity: 1;
            color: #e63946;
        }
        th[data-sort-direction="desc"] .sort-indicator::after {
            content: '▼';
            opacity: 1;
            color: #e63946;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e63946;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-pkmn-bg text-gray-800">

    <div class="container mx-auto p-2 sm:p-4 md:p-8">
        <header class="text-center mb-6 p-3 sm:p-6 bg-pkmn-header-bg rounded-xl border-b-4 border-pkmn-light-blue">
            <h1 class="text-2xl sm:text-4xl md:text-5xl font-black text-pkmn-blue uppercase tracking-widest">TOWN MAP</h1>
            <p class="text-xs sm:text-md text-gray-600 mt-1 sm:mt-3 tracking-wider">Torneios de Pokémon TCG em São Paulo</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-3 sm:p-6">
            <!-- API Status Section -->
            <div id="api-status-section" class="mb-6 p-4 border-l-4 border-pkmn-blue bg-blue-50 rounded-r-lg flex items-center justify-between">
                <div class="flex items-center">
                    <div id="loading-spinner" class="loader"></div>
                    <div>
                        <p id="status-message" class="font-bold text-pkmn-blue">Conectando à PokéData API...</p>
                        <p id="status-subtext" class="text-xs text-gray-500">Buscando eventos recentes.</p>
                    </div>
                </div>
                <button id="retry-button" class="hidden px-4 py-2 bg-pkmn-red text-white text-sm font-bold rounded hover:bg-red-700 transition">
                    Tentar Novamente
                </button>
            </div>

            <!-- Filter and Search Controls -->
            <div class="mb-4">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Pesquisar</label>
                <input type="text" id="search-input" placeholder="Buscar por nome, cidade, loja..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
                <div>
                    <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Tipo</label>
                    <select id="type-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todos os Tipos</option>
                    </select>
                </div>
                <div>
                    <label for="city-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Cidade</label>
                    <select id="city-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todas as Cidades</option>
                    </select>
                </div>
                <div>
                    <label for="month-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Mês</label>
                    <select id="month-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todos os Meses</option>
                    </select>
                </div>
            </div>

            <!-- Events Table -->
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-pkmn-header-bg">
                        <tr>
                            <th scope="col" class="hidden sm:table-cell px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="name">Evento<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="type">Tipo<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="when">Data<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="shop">Loja<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="city">Cidade<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="events-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
                 <div id="no-results" class="text-center py-8 text-gray-500 hidden">
                    <p>Nenhum evento encontrado.</p>
                </div>
            </div>
        </main>

        <!-- Details Modal/Panel -->
        <div id="details-panel" class="fixed inset-y-0 right-0 w-full sm:w-2/3 md:w-1/2 lg:w-1/3 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto border-l-4 border-pkmn-blue">
             <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="details-name" class="text-xl font-bold text-pkmn-blue">Detalhes do Evento</h2>
                    <button id="close-details" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="details-content" class="space-y-4 text-sm">
                    <!-- Details will be dynamically inserted here -->
                </div>
            </div>
        </div>
        <div id="details-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const API_URL = 'https://pokedata.ovh/events/api/_tcg/cups/challenges/pre/_country/BR'; 

            // --- DOM Elements ---
            const tableBody = document.getElementById('events-table-body');
            const searchInput = document.getElementById('search-input');
            const typeFilter = document.getElementById('type-filter');
            const cityFilter = document.getElementById('city-filter');
            const monthFilter = document.getElementById('month-filter');
            const detailsPanel = document.getElementById('details-panel');
            const detailsOverlay = document.getElementById('details-overlay');
            const closeDetailsButton = document.getElementById('close-details');
            const detailsName = document.getElementById('details-name');
            const detailsContent = document.getElementById('details-content');
            const noResultsDiv = document.getElementById('no-results');
            
            // Status Elements
            const statusMessage = document.getElementById('status-message');
            const statusSubtext = document.getElementById('status-subtext');
            const loadingSpinner = document.getElementById('loading-spinner');
            const retryButton = document.getElementById('retry-button');
            const apiStatusSection = document.getElementById('api-status-section');

            let allEvents = [];
            let currentSort = { key: 'when', direction: 'asc' };

            // --- API Handling ---
            async function fetchEventsFromAPI() {
                setLoadingState(true);
                let data;
                
                try {
                    // Tentativa 1: Fetch direto
                    try {
                        console.log("Tentando conexão direta...");
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error('Erro na conexão direta');
                        data = await response.json();
                    } catch (directError) {
                        console.warn("Conexão direta falhou (provavelmente CORS), tentando proxy...", directError);
                        
                        // Tentativa 2: Fetch via Proxy (para contornar CORS em navegadores)
                        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(API_URL);
                        const proxyResponse = await fetch(proxyUrl);
                        if (!proxyResponse.ok) throw new Error('Erro na conexão via proxy');
                        data = await proxyResponse.json();
                    }
                    
                    // Normalização básica caso a API retorne chaves ligeiramente diferentes
                    let eventsArray = Array.isArray(data) ? data : (data.events || []);

                    if (!eventsArray || eventsArray.length === 0) {
                        throw new Error("A API retornou uma lista vazia de eventos no Brasil.");
                    }

                    // FILTRO ROBUSTO: Manter apenas eventos de São Paulo
                    allEvents = eventsArray.filter(event => {
                         if (!event) return false;

                         // Normalizar strings para comparação (upper case, sem espaços extras)
                         const state = (event.state || '').toString().trim().toUpperCase();
                         const city = (event.city || '').toString().trim().toUpperCase();
                         
                         // Função auxiliar para remover acentos (ex: SÃO -> SAO)
                         const removeAccents = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                         const cleanState = removeAccents(state);
                         const cleanCity = removeAccents(city);

                         // Verifica variações comuns
                         return cleanState === 'SP' || 
                                cleanState.includes('SAO PAULO') || 
                                cleanCity.includes('SAO PAULO');
                    });

                    setLoadingState(false, true);
                    
                    if (allEvents.length === 0) {
                        // Se conectou mas o filtro removeu tudo
                        console.warn("Eventos carregados do Brasil, mas nenhum correspondeu ao filtro 'São Paulo'.");
                        noResultsDiv.classList.remove('hidden');
                        noResultsDiv.querySelector('p').textContent = "Conectado à API, mas nenhum evento encontrado em São Paulo no momento.";
                    } else {
                        populateFilters(allEvents);
                        filterAndSortEvents();
                    }

                } catch (error) {
                    console.error("Falha crítica ao buscar API:", error);
                    setLoadingState(false, false, error.message);
                }
            }

            function setLoadingState(isLoading, isSuccess = false, errorMessage = '') {
                if (isLoading) {
                    loadingSpinner.style.display = 'inline-block';
                    retryButton.classList.add('hidden');
                    statusMessage.textContent = "Conectando à PokéData API...";
                    statusMessage.className = "font-bold text-pkmn-blue";
                    statusSubtext.textContent = "Buscando eventos recentes (Tentando conexão direta e proxy)...";
                    apiStatusSection.className = "mb-6 p-4 border-l-4 border-pkmn-blue bg-blue-50 rounded-r-lg flex items-center justify-between";
                } else if (isSuccess) {
                    loadingSpinner.style.display = 'none';
                    statusMessage.textContent = "Dados Atualizados!";
                    statusMessage.className = "font-bold text-green-700";
                    statusSubtext.textContent = `Carregados ${allEvents.length} eventos em São Paulo.`;
                    apiStatusSection.className = "mb-6 p-4 border-l-4 border-green-500 bg-green-50 rounded-r-lg flex items-center justify-between";
                    // Esconde a barra de status após 5 segundos se for sucesso
                    setTimeout(() => {
                        apiStatusSection.classList.add('hidden');
                    }, 5000);
                } else {
                    // Erro
                    loadingSpinner.style.display = 'none';
                    retryButton.classList.remove('hidden');
                    statusMessage.textContent = "Erro ao carregar dados";
                    statusMessage.className = "font-bold text-red-700";
                    statusSubtext.textContent = `Não foi possível carregar os dados. Detalhe: ${errorMessage}`;
                    apiStatusSection.className = "mb-6 p-4 border-l-4 border-pkmn-red bg-red-50 rounded-r-lg flex items-center justify-between";
                }
            }

            // --- UI Rendering ---
            function renderTable(events) {
                tableBody.innerHTML = '';
                if (events.length === 0) {
                    noResultsDiv.classList.remove('hidden');
                    // Mensagem específica dependendo se temos dados carregados mas filtrados pela busca
                    if (allEvents.length > 0) {
                         noResultsDiv.querySelector('p').textContent = "Nenhum resultado encontrado para os filtros aplicados.";
                    }
                } else {
                    noResultsDiv.classList.add('hidden');
                }
                
                events.forEach(event => {
                    const row = document.createElement('tr');
                    row.className = 'cursor-pointer table-row-hover transition-colors duration-200';
                    
                    const whenDate = new Date(event.when);
                    const formattedDate = !isNaN(whenDate) ? 
                        whenDate.toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            timeZone: 'America/Sao_Paulo'
                        }) : 'Data inválida';

                    let abbreviatedType = event.type || 'Evento';
                    let fullTypeName = event.type || 'Evento';
                    let typeClass = 'bg-gray-100 text-gray-800'; // Default

                    if (fullTypeName === 'League Challenge') {
                        abbreviatedType = 'Challenge';
                        typeClass = 'bg-blue-100 text-blue-800';
                    } else if (fullTypeName === 'League Cup') {
                        abbreviatedType = 'Cup';
                        typeClass = 'bg-red-100 text-red-800';
                    } else if (fullTypeName && fullTypeName.toLowerCase().includes('prerelease')) {
                        abbreviatedType = 'Pré Release';
                        fullTypeName = 'Pré Release'; // Manter consistência
                        typeClass = 'bg-green-100 text-green-800';
                    }

                    row.innerHTML = `
                        <td class="hidden sm:table-cell px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">
                            <div class="font-medium text-gray-900">${event.name || 'Sem Nome'}</div>
                        </td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">
                             <span class="sm:hidden px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                ${abbreviatedType}
                            </span>
                             <span class="hidden sm:inline-flex px-2 text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                ${fullTypeName}
                            </span>
                        </td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${formattedDate}</td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${event.shop || '-'}</td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${event.city || '-'}</td>
                    `;
                    row.addEventListener('click', () => showDetails(event));
                    tableBody.appendChild(row);
                });
            }

            function populateFilters(events) {
                // Preserve current selections if possible, or reset to 'all'
                const currentType = typeFilter.value;
                const currentCity = cityFilter.value;
                const currentMonth = monthFilter.value;

                typeFilter.innerHTML = '<option value="all">Todos os Tipos</option>';
                cityFilter.innerHTML = '<option value="all">Todas as Cidades</option>';
                monthFilter.innerHTML = '<option value="all">Todos os Meses</option>';
                
                const types = [...new Set(events.map(e => e.type))];
                const cities = [...new Set(events.map(e => e.city))].sort((a, b) => (a || '').localeCompare(b || ''));

                types.forEach(type => {
                    if(!type) return;
                    const option = document.createElement('option');
                    option.value = type;
                    
                    if (type.toLowerCase().includes('prerelease')) {
                        option.textContent = 'Pré Release';
                    } else {
                        option.textContent = type;
                    }

                    typeFilter.appendChild(option);
                });

                cities.forEach(city => {
                    if (city) {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        cityFilter.appendChild(option);
                    }
                });

                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const months = [...new Set(events.map(e => {
                    const date = new Date(e.when);
                    return isNaN(date) ? null : date.getUTCMonth();
                }).filter(m => m !== null))].sort((a, b) => a - b);

                months.forEach(monthIndex => {
                    const option = document.createElement('option');
                    option.value = monthIndex;
                    option.textContent = monthNames[monthIndex];
                    monthFilter.appendChild(option);
                });
                
                // Restore values if they still exist in the new options
                if ([...typeFilter.options].some(o => o.value === currentType)) typeFilter.value = currentType;
                if ([...cityFilter.options].some(o => o.value === currentCity)) cityFilter.value = currentCity;
                if ([...monthFilter.options].some(o => o.value === currentMonth)) monthFilter.value = currentMonth;
            }

            // --- Details Panel ---
            function showDetails(event) {
                detailsName.textContent = event.name || 'Detalhes do Evento';
                
                const whenDate = new Date(event.when);
                const formattedDate = !isNaN(whenDate) ? whenDate.toLocaleString('pt-br', { dateStyle: 'full', timeStyle: 'short', timeZone: 'America/Sao_Paulo' }) : 'Data inválida';

                // Tratamento robusto para encontrar o endereço
                const address = event.address || event.street_address || event.street_adress || 'Endereço não informado';

                let pokemonEventLinkHTML = '';
                if (event.pokemon_url && event.pokemon_url.trim() !== '') {
                    // Correção: Usa URL base oficial de eventos Play! Pokémon
                    let officialEventUrl = event.pokemon_url;
                    
                    // Se a URL não começar com http, assume que é um ID e concatena na base URL correta
                    if (!officialEventUrl.startsWith('http')) {
                        officialEventUrl = `https://www.pokemon.com/us/play-pokemon/pokemon-events/${event.pokemon_url}`;
                    }

                    pokemonEventLinkHTML = `
                        <a href="${officialEventUrl}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center inline-block bg-pkmn-blue text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 transition">
                           Página do Evento
                        </a>`;
                }

                detailsContent.innerHTML = `
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Tipo:</strong> ${event.type || '-'}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Loja:</strong> ${event.shop || '-'}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Data:</strong> ${formattedDate}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Endereço:</strong> ${address}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Cidade:</strong> ${event.city || '-'}, ${event.state || ''}</p>
                    <div class="mt-6 space-y-2">
                        <a href="https://www.google.com/maps?q=${event.latitude},${event.longitude}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center inline-block bg-pkmn-red text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                           Ver no Google Maps
                        </a>
                        ${pokemonEventLinkHTML}
                    </div>
                `;

                detailsPanel.classList.remove('translate-x-full');
                detailsOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            function hideDetails() {
                detailsPanel.classList.add('translate-x-full');
                detailsOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // --- Filtering and Sorting Logic ---
            function filterAndSortEvents() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedType = typeFilter.value;
                const selectedCity = cityFilter.value;
                const selectedMonth = monthFilter.value;

                let filtered = allEvents.filter(event => {
                    const matchesSearch = searchTerm === '' || 
                        Object.values(event).some(val => 
                            String(val).toLowerCase().includes(searchTerm)
                        );
                    const matchesType = selectedType === 'all' || event.type === selectedType;
                    const matchesCity = selectedCity === 'all' || event.city === selectedCity;
                    const eventDate = new Date(event.when);
                    const matchesMonth = selectedMonth === 'all' || (isNaN(eventDate) ? false : eventDate.getUTCMonth() == selectedMonth);
                    
                    return matchesSearch && matchesType && matchesCity && matchesMonth;
                });
                
                filtered.sort((a, b) => {
                    let valA = a[currentSort.key];
                    let valB = b[currentSort.key];

                    if (currentSort.key === 'when') {
                        valA = new Date(valA).getTime();
                        valB = new Date(valB).getTime();
                    } else if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }

                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                renderTable(filtered);
            }
            
            function handleSort(e) {
                const th = e.target.closest('th[data-sort]');
                if (!th) return;
                
                const key = th.dataset.sort;

                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = key;
                    currentSort.direction = 'asc';
                }
                
                document.querySelectorAll('th[data-sort]').forEach(header => {
                    header.removeAttribute('data-sort-direction');
                });
                th.setAttribute('data-sort-direction', currentSort.direction);

                filterAndSortEvents();
            }
            
            // --- Initial Setup & Event Listeners ---
            searchInput.addEventListener('input', filterAndSortEvents);
            typeFilter.addEventListener('change', filterAndSortEvents);
            cityFilter.addEventListener('change', filterAndSortEvents);
            monthFilter.addEventListener('change', filterAndSortEvents);
            closeDetailsButton.addEventListener('click', hideDetails);
            detailsOverlay.addEventListener('click', hideDetails);
            document.querySelector('thead').addEventListener('click', handleSort);
            retryButton.addEventListener('click', fetchEventsFromAPI);
            
            // Start Load
            fetchEventsFromAPI();
        });
    </script>
</body>
</html>
