<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Pokémon TCG - São Paulo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pkmn-blue': '#1c3b69',
                        'pkmn-red': '#e63946',
                        'pkmn-bg': '#e8f0f8',
                        'pkmn-header-bg': '#d6e2ef',
                        'pkmn-light-blue': '#a8dadc',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #aaa;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Simple transition for table rows */
        .table-row-hover:hover {
            background-color: #f0f0f0;
        }
        /* Styles for sort indicators */
        .sort-indicator::after {
            content: '';
            display: inline-block;
            margin-left: 0.5rem;
            opacity: 0.5;
            font-size: 0.65em;
            vertical-align: middle;
        }
        th[data-sort-direction="asc"] .sort-indicator::after {
            content: '▲';
            opacity: 1;
            color: #e63946;
        }
        th[data-sort-direction="desc"] .sort-indicator::after {
            content: '▼';
            opacity: 1;
            color: #e63946;
        }
    </style>
</head>
<body class="bg-pkmn-bg text-gray-800">

    <div class="container mx-auto p-2 sm:p-4 md:p-8">
        <header class="text-center mb-6 p-3 sm:p-6 bg-pkmn-header-bg rounded-xl border-b-4 border-pkmn-light-blue">
            <h1 class="text-2xl sm:text-4xl md:text-5xl font-black text-pkmn-blue uppercase tracking-widest">TOWN MAP</h1>
            <p class="text-xs sm:text-md text-gray-600 mt-1 sm:mt-3 tracking-wider">Torneios de Pokémon TCG em São Paulo</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-3 sm:p-6">
            <!-- File Upload Section -->
            <div id="file-upload-section" class="mb-6 p-6 border-2 border-dashed border-pkmn-light-blue rounded-lg text-center bg-white">
                <label for="csv-file-input" class="cursor-pointer text-pkmn-blue hover:text-blue-800 font-medium transition">
                    <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V16a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 9h4m-4 4h4m-4 4h4"></path></svg>
                    Clique aqui para carregar o arquivo <span class="font-bold">export_events.csv</span>
                </label>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                <p id="file-name-span" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- Filter and Search Controls -->
            <div class="mb-4">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Pesquisar</label>
                <input type="text" id="search-input" placeholder="Buscar por nome, cidade, loja..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
                <div>
                    <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Tipo</label>
                    <select id="type-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todos os Tipos</option>
                    </select>
                </div>
                <div>
                    <label for="city-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Cidade</label>
                    <select id="city-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todas as Cidades</option>
                    </select>
                </div>
                <div>
                    <label for="month-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Mês</label>
                    <select id="month-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pkmn-red focus:border-pkmn-red transition bg-white">
                        <option value="all">Todos os Meses</option>
                    </select>
                </div>
            </div>

            <!-- Events Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-pkmn-header-bg">
                        <tr>
                            <th scope="col" class="hidden sm:table-cell px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="name">Evento<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="type">Tipo<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="when">Data<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="shop">Loja<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-bold text-pkmn-blue uppercase tracking-wider cursor-pointer" data-sort="city">Cidade<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="events-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
                 <div id="no-results" class="text-center py-8 text-gray-500">
                    <p>Procurando export_events.csv... Se não for encontrado, clique na área acima para carregar manualmente.</p>
                </div>
            </div>
        </main>

        <!-- Details Modal/Panel -->
        <div id="details-panel" class="fixed inset-y-0 right-0 w-full sm:w-2/3 md:w-1/2 lg:w-1/3 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto border-l-4 border-pkmn-blue">
             <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="details-name" class="text-xl font-bold text-pkmn-blue">Detalhes do Evento</h2>
                    <button id="close-details" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="details-content" class="space-y-4 text-sm">
                    <!-- Details will be dynamically inserted here -->
                </div>
            </div>
        </div>
        <div id="details-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const tableBody = document.getElementById('events-table-body');
            const searchInput = document.getElementById('search-input');
            const typeFilter = document.getElementById('type-filter');
            const cityFilter = document.getElementById('city-filter');
            const monthFilter = document.getElementById('month-filter');
            const detailsPanel = document.getElementById('details-panel');
            const detailsOverlay = document.getElementById('details-overlay');
            const closeDetailsButton = document.getElementById('close-details');
            const detailsName = document.getElementById('details-name');
            const detailsContent = document.getElementById('details-content');
            const noResultsDiv = document.getElementById('no-results');
            const fileInput = document.getElementById('csv-file-input');
            const fileNameSpan = document.getElementById('file-name-span');
            const fileUploadSection = document.getElementById('file-upload-section');

            let allEvents = [];
            let currentSort = { key: 'when', direction: 'asc' };

            // --- Data Parsing ---
            function parseCSV(data) {
                const rows = data.trim().split('\n');
                if (rows.length < 2) throw new Error("CSV file is empty or has only a header.");
                const headers = rows[0].split(';');
                return rows.slice(1).map(row => {
                    const values = row.split(/;(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(val => val.replace(/"/g, '').trim());
                    if (values.length !== headers.length) {
                         console.warn("Row with mismatching column count:", row);
                         return null;
                    }
                    return headers.reduce((obj, header, i) => {
                        obj[header.trim()] = values[i];
                        return obj;
                    }, {});
                }).filter(Boolean);
            }

            // --- UI Rendering ---
            function renderTable(events) {
                tableBody.innerHTML = '';
                if (events.length === 0) {
                    noResultsDiv.classList.remove('hidden');
                    noResultsDiv.querySelector('p').textContent = "Nenhum resultado encontrado para os filtros aplicados.";
                } else {
                    noResultsDiv.classList.add('hidden');
                }
                
                events.forEach(event => {
                    const row = document.createElement('tr');
                    row.className = 'cursor-pointer table-row-hover transition-colors duration-200';
                    
                    const whenDate = new Date(event.when);
                    const formattedDate = !isNaN(whenDate) ? 
                        whenDate.toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            timeZone: 'UTC'
                        }) : 'Data inválida';

                    let abbreviatedType = event.type;
                    let fullTypeName = event.type;
                    let typeClass = 'bg-gray-100 text-gray-800'; // Default

                    if (event.type === 'League Challenge') {
                        abbreviatedType = 'Challenge';
                        typeClass = 'bg-blue-100 text-blue-800';
                    } else if (event.type === 'League Cup') {
                        abbreviatedType = 'Cup';
                        typeClass = 'bg-red-100 text-red-800';
                    } else if (event.type.toLowerCase().includes('prerelease')) {
                        abbreviatedType = 'Pré Release';
                        fullTypeName = 'Pré Release'; // Manter consistência
                        typeClass = 'bg-green-100 text-green-800';
                    }

                    row.innerHTML = `
                        <td class="hidden sm:table-cell px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">
                            <div class="font-medium text-gray-900">${event.name}</div>
                        </td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">
                             <span class="sm:hidden px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                ${abbreviatedType}
                            </span>
                             <span class="hidden sm:inline-flex px-2 text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                ${fullTypeName}
                            </span>
                        </td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${formattedDate}</td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${event.shop}</td>
                        <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${event.city}</td>
                    `;
                    row.addEventListener('click', () => showDetails(event));
                    tableBody.appendChild(row);
                });
            }
            
            function processAndDisplayData(csvText) {
                try {
                    allEvents = parseCSV(csvText);
                    populateFilters(allEvents);
                    document.querySelector(`th[data-sort="${currentSort.key}"]`).setAttribute('data-sort-direction', currentSort.direction);
                    filterAndSortEvents();
                } catch (error) {
                    console.error("Error parsing CSV:", error);
                    noResultsDiv.querySelector('p').textContent = "Erro ao ler o arquivo. Verifique se o formato CSV está correto e tente novamente.";
                    noResultsDiv.classList.remove('hidden');
                    tableBody.innerHTML = '';
                }
            }


            function populateFilters(events) {
                typeFilter.innerHTML = '<option value="all">Todos os Tipos</option>';
                cityFilter.innerHTML = '<option value="all">Todas as Cidades</option>';
                monthFilter.innerHTML = '<option value="all">Todos os Meses</option>';
                
                const types = [...new Set(events.map(e => e.type))];
                const cities = [...new Set(events.map(e => e.city))].sort((a, b) => a.localeCompare(b));

                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    
                    if (type.toLowerCase().includes('prerelease')) {
                        option.textContent = 'Pré Release';
                    } else {
                        option.textContent = type;
                    }

                    typeFilter.appendChild(option);
                });

                cities.forEach(city => {
                    if (city) {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        cityFilter.appendChild(option);
                    }
                });

                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const months = [...new Set(events.map(e => {
                    const date = new Date(e.when);
                    return isNaN(date) ? null : date.getUTCMonth();
                }).filter(m => m !== null))].sort((a, b) => a - b);

                months.forEach(monthIndex => {
                    const option = document.createElement('option');
                    option.value = monthIndex;
                    option.textContent = monthNames[monthIndex];
                    monthFilter.appendChild(option);
                });
            }

            // --- Details Panel ---
            function showDetails(event) {
                detailsName.textContent = event.name;
                
                const whenDate = new Date(event.when);
                const formattedDate = !isNaN(whenDate) ? whenDate.toLocaleString('pt-br', { dateStyle: 'full', timeStyle: 'short', timeZone: 'UTC' }) : 'Data inválida';

                let pokemonEventLinkHTML = '';
                if (event.pokemon_url && event.pokemon_url.trim() !== '') {
                    const officialEventUrl = `https://www.pokemon.com/us/pokemon-trainer-club/play-pokemon-tournaments/${event.pokemon_url}`;
                    pokemonEventLinkHTML = `
                        <a href="${officialEventUrl}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center inline-block bg-pkmn-blue text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 transition">
                           Página do Evento
                        </a>`;
                }

                detailsContent.innerHTML = `
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Tipo:</strong> ${event.type}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Loja:</strong> ${event.shop}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Data:</strong> ${formattedDate}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Endereço:</strong> ${event.street_adress}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">Cidade:</strong> ${event.city}, ${event.state}</p>
                    <p><strong class="font-semibold text-gray-600 w-28 inline-block">CEP:</strong> ${event.postal_code || 'N/A'}</p>
                    <div class="mt-6 space-y-2">
                        <a href="https://www.google.com/maps?q=${event.latitude},${event.longitude}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center inline-block bg-pkmn-red text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                           Ver no Google Maps
                        </a>
                        ${pokemonEventLinkHTML}
                    </div>
                `;

                detailsPanel.classList.remove('translate-x-full');
                detailsOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            function hideDetails() {
                detailsPanel.classList.add('translate-x-full');
                detailsOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // --- Filtering and Sorting Logic ---
            function filterAndSortEvents() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedType = typeFilter.value;
                const selectedCity = cityFilter.value;
                const selectedMonth = monthFilter.value;

                let filtered = allEvents.filter(event => {
                    const matchesSearch = searchTerm === '' || 
                        Object.values(event).some(val => 
                            String(val).toLowerCase().includes(searchTerm)
                        );
                    const matchesType = selectedType === 'all' || event.type === selectedType;
                    const matchesCity = selectedCity === 'all' || event.city === selectedCity;
                    const eventDate = new Date(event.when);
                    const matchesMonth = selectedMonth === 'all' || (isNaN(eventDate) ? false : eventDate.getUTCMonth() == selectedMonth);
                    
                    return matchesSearch && matchesType && matchesCity && matchesMonth;
                });
                
                filtered.sort((a, b) => {
                    let valA = a[currentSort.key];
                    let valB = b[currentSort.key];

                    if (currentSort.key === 'when') {
                        valA = new Date(valA).getTime();
                        valB = new Date(valB).getTime();
                    }

                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                renderTable(filtered);
            }
            
            function handleSort(e) {
                const th = e.target.closest('th[data-sort]');
                if (!th) return;
                
                const key = th.dataset.sort;

                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = key;
                    currentSort.direction = 'asc';
                }
                
                document.querySelectorAll('th[data-sort]').forEach(header => {
                    header.removeAttribute('data-sort-direction');
                });
                th.setAttribute('data-sort-direction', currentSort.direction);

                filterAndSortEvents();
            }
            
            // --- File Handlers ---
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (!file) return;

                fileNameSpan.textContent = `Arquivo: ${file.name}`;
                const reader = new FileReader();
                
                reader.onload = event => {
                    processAndDisplayData(event.target.result);
                };
                reader.readAsText(file);
            }
            
            async function loadInitialData() {
                try {
                    const response = await fetch('export_events.csv');
                    if (!response.ok) {
                        throw new Error('Arquivo export_events.csv não encontrado. Carregue-o manualmente.');
                    }
                    const csvText = await response.text();
                    fileUploadSection.classList.add('hidden');
                    processAndDisplayData(csvText);
                } catch (error) {
                    console.warn(error.message);
                    noResultsDiv.querySelector('p').textContent = "Por favor, carregue um arquivo export_events.csv para visualizar os dados.";
                }
            }

            // --- Initial Setup & Event Listeners ---
            fileInput.addEventListener('change', handleFileSelect);
            searchInput.addEventListener('input', filterAndSortEvents);
            typeFilter.addEventListener('change', filterAndSortEvents);
            cityFilter.addEventListener('change', filterAndSortEvents);
            monthFilter.addEventListener('change', filterAndSortEvents);
            closeDetailsButton.addEventListener('click', hideDetails);
            detailsOverlay.addEventListener('click', hideDetails);
            document.querySelector('thead').addEventListener('click', handleSort);
            
            loadInitialData();
        });
    </script>
</body>
</html>


